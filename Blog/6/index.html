<!DocType HTML>

<HTML>
	<Head>
		<Meta Charset = "UTF-8" />
		<Meta Name = "Viewport" Content = "Width=Device-Width, Initial-Scale=1, User-Scalable=No" />
		<Title>【Mastodon】非公開トゥートの挙動を変えてみた話。 | どっかのプログラなーいのブログ。</Title>

		<Script Src = "/assets/includes/DOM Extender v3.4.js"></Script>
		<Script Src = "/assets/includes/material-components-web.min.js"></Script>
		<Link Rel = "StyleSheet" Href = "/assets/includes/material-components-web.min.css" />

		<Script Src = "/assets/includes/common/common.js"></Script>
		<Link Rel = "StyleSheet" Href = "/assets/includes/common/common.css" />

		<Link Rel = "StyleSheet" Href = "../Blog.css" />

		<!-- Global site tag (gtag.js) - Google Analytics -->
		<Script Src = "https://www.googletagmanager.com/gtag/js?id=UA-111257667-1" Async = "Async"></Script>
		<Script>
			window.dataLayer = window.dataLayer || [];
			function gtag () { dataLayer.push(arguments) }
			
			gtag('js', new Date());
			gtag('set', {'user_id': 'USER_ID'}); // ログインしている user_id を使用してUser-ID を設定します。
			gtag('config', 'UA-111257667-1');
		</Script>
	</Head>

	<Body>
		<Main>
			<H1 ID = "Article-Info" Class = "mdc-typography--headline" Style = '--createdAt: "(投稿日時：2018/3/26)"'>
				<Span ID = "Article-Info-Title">【Mastodon】非公開トゥートの挙動を変えてみた話。</Span>
			</H1>

			<Section ID = "Article-Content" Class = "mdc-typography--body2">どうも、みなさんこんにちは。Genbooです。
今日から春休みに入り、時間的にも余裕が出てきました。
時間にモチベも重なって、久しぶりにプログラミングにのめり込めてる気がします。

さて、最近ですがMastodonというSNSに没頭しています。
それも世界1位のTPD(Toot per Days, 要するに1日の平均投稿率)ユーザーにも数回なっています……ｗ

<S>つまり廃人ですね(白目)</S>

そこで最近はMastodon関連のツールを製作することがかなり増えてきました。
それにとどまらず、Mastodon自体のソースにも手を出し始め……。
という事で改善してみた機能が非公開トゥートになります。

また、開発にあたって参考にさせて頂きました！！ありがとうございます！！🙏🙏🙏
<Script Src = "https://gamelinks007.net/embed.js" Async = "Async"></Script>
<IFrame Class = "mastodon-embed" Src = "https://gamelinks007.net/@S_H_/99691071767594021/embed" Style = "Max-Width: 100%; Border: 0" Width="400"></IFrame>

<H2 Class = "mdc-typography--subheading2">実際の挙動</H2>
元来Mastodonには非公開トゥートの機能が実装されています。
しかし十分に満足できる挙動<A Href = "#表1"><Sup>[表1]</Sup></A>ではなく、また不便なシチュエーションも多々出てきたため
『じゃあいっちょ変えてみっか！！』の一声で開発を始めました。

<Span ID = "表1">[表1]</Span>
<Table Border = "1">
	<THead>
		<Tr><Th>Mastodon</Th><Th>理想</Th></Tr>
	</THead>
	
	<TBody>
		<Tr>
			<Td>自分の<B>フォロワー</B>に公開</Td>
			<Td>自分が<B>フォローしているユーザー</B>に公開</Td>
		</Tr>
		
		<Tr>
			<Td><Img Src = "001.png" Alt = "参考画像" /></Td>
			<Td><Img Src = "002.png" Alt = "参考画像" /></Td>
		</Tr>
	</TBody>
</Table>

改善された非公開トゥートのコードは<A Href = "https://github.com/GenbuProject/mastodon/tree/feature/privateToot" Target = "_blank">Github</A>に上げてあります。
Rubyに関しては初心者どころか全くの未経験者なので、基礎的な部分の理解すらままならずにコミットしてしまったりでコミット数が多くなっていますが、修正箇所はかなり少なかったです。

以下にて行程ごとに分けて解説をしていきます💪💪

<H2 Class = "mdc-typography--subheading2">投稿処理を探し当てる</H2>
まずサーバー側の処理、という事でRubyのコードを漁っていきます。
app/controller直下にAPI群があったので、漁っていったところstatuses_controller.rbがありました。

このコードを覗いてみると、createメソッドでPostStatusServiceが呼ばれています。
つまり、PostStatusServiceに処理が書かれているはずです。

……このように芋づる式にコードを辿っていきます。

辿った結果、投稿の配信処理は同インスタンスに対してはapp/services/fan_out_on_write_service.rb、
他インスタンスに対してはapp/workers/activitypub/distribution_worker.rbということが分かりました！！

<H2 Class = "mdc-typography--subheading2">app/services/fan_out_on_write_service.rb</H2></Section>

			<Section ID = "disqus_thread">
				<Script>
					/**
					*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
					*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
					/*
					var disqus_config = function () {
						this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
						this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
					};
					*/
					(() => { // DON'T EDIT BELOW THIS LINE
						var d = document, s = d.createElement('script');
							s.src = 'https://genbuhase-blog.disqus.com/embed.js';
							s.setAttribute('data-timestamp', +new Date());
						(d.head || d.body).appendChild(s);
					})();
				</Script>
	
				<NoScript>
					Please enable JavaScript to view the <A Href = "https://disqus.com/?ref_noscript">comments powered by Disqus.</A>
				</NoScript>
			</Section>
		</Main>
	</Body>
</HTML>