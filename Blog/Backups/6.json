{
	"title": "【Mastodon】非公開トゥートの挙動を変えてみた話。",
	"createdAt": "2018/3/26",
	"content": "どうも、みなさんこんにちは。Genbooです。\n今日から春休みに入り、時間的にも余裕が出てきました。\n時間にモチベも重なって、久しぶりにプログラミングにのめり込めてる気がします。\n\nさて、最近ですがMastodonというSNSに没頭しています。\nそれも世界1位のTPD(Toot per Days, 要するに1日の平均投稿率)ユーザーにも数回なっています……ｗ\n\n<S>つまり廃人ですね(白目)</S>\n\nそこで最近はMastodon関連のツールを製作することがかなり増えてきました。\nそれにとどまらず、Mastodon自体のソースにも手を出し始め……。\nという事で改善してみた機能が非公開トゥートになります。\n\nまた、開発にあたって参考にさせて頂きました！！ありがとうございます！！🙏🙏🙏\n<Script Src = \"https://gamelinks007.net/embed.js\" Async = \"Async\"></Script>\n<IFrame Class = \"mastodon-embed\" Src = \"https://gamelinks007.net/@S_H_/99691071767594021/embed\" Style = \"Max-Width: 100%; Border: 0\" Width=\"400\"></IFrame>\n\n<H2 Class = \"mdc-typography--subheading2\">実際の挙動</H2>\n元来Mastodonには非公開トゥートの機能が実装されています。\nしかし十分に満足できる@[挙動](表1)ではなく、また不便なシチュエーションも多々出てきたため\n『じゃあいっちょ変えてみっか！！』の一声で開発を始めました。\n\n@表1\n<Table Border = \"1\">\n\t<THead>\n\t\t<Tr><Th>Mastodon</Th><Th>理想</Th></Tr>\n\t</THead>\n\t\n\t<TBody>\n\t\t<Tr>\n\t\t\t<Td>自分の<B>フォロワー</B>に公開</Td>\n\t\t\t<Td>自分が<B>フォローしているユーザー</B>に公開</Td>\n\t\t</Tr>\n\t\t\n\t\t<Tr>\n\t\t\t<Td>![参考画像](001.png)</Td>\n\t\t\t<Td>![参考画像](002.png)</Td>\n\t\t</Tr>\n\t</TBody>\n</Table>\n@@\n\n改善された非公開トゥートのコードは:[Github](https://github.com/GenbuProject/mastodon/tree/feature/privateToot)に上げてあります。\nRubyに関しては初心者どころか全くの未経験者なので、基礎的な部分の理解すらままならずにコミットしてしまったりでコミット数が多くなっていますが、修正箇所はかなり少なかったです。\n\n以下にて行程ごとに分けて解説をしていきます💪💪\n\n<H2 Class = \"mdc-typography--subheading2\">投稿処理を探し当てる</H2>\nまずサーバー側の処理、という事でRubyのコードを漁っていきます。\napp/controller直下にAPI群があったので、漁っていったところstatuses_controller.rbがありました。\n\nこのコードを覗いてみると、createメソッドでPostStatusServiceが呼ばれています。\nつまり、PostStatusServiceに処理が書かれているはずです。\n\n……このように芋づる式にコードを辿っていきます。\n\n辿った結果、投稿の配信処理は同インスタンスに対してはapp/services/fan_out_on_write_service.rb、\n他インスタンスに対してはapp/workers/activitypub/distribution_worker.rbということが分かりました！！\n\n<H2 Class = \"mdc-typography--subheading2\">app/services/fan_out_on_write_service.rb</H2>"
}